let inventoryPending=!1;var currentFetchedInventory=[],inventoryModeTotal=!1;function loadInventoryPrices(){let e=document.querySelectorAll(nodeNames.hudItems);if(e.length>0&&!inventoryPending){let t=[],n=[];e.forEach(e=>{let r=e.querySelector(nodeNames.hudItemImage);if(r){if(r.complete){let i=calculateAverageColor(r);t.push(i),n.push(e)}else r.onload=function(){let i=calculateAverageColor(r);t.push(i),n.push(e)}}}),t.length>0&&(inventoryPending=!0,sendRequestByHash(t).then(e=>{setPricesInInventory(e,n),inventoryPending=!1}).catch(e=>{console.error(e),inventoryPending=!1}))}}function getInventoryWithQuantities(e){let t={},n=document.querySelectorAll(nodeNames.hudItems),r=0;n.forEach((n,i)=>{if(n.querySelector(nodeNames.clickable)){let i=n.querySelector(nodeNames.hudQuantities);if(i){let n=e[r],o=i.textContent.replace("x","");o=""===o?1:parseInt(o,10),t[n.displayName]?t[n.displayName]+=o:t[n.displayName]=o}r++}}),currentFetchedInventory=Object.entries(t).map(([e,t])=>({displayName:e,quantity:t}))}function setPricesInInventory(e,t){e.forEach((e,n)=>{let r=t[n];function i(e){return e>9999?nFormatter(e,1):e}if(null!==e.price.price){let t=r.querySelector(".voxels-inventory-price"),n=e.price.price;if(inventoryModeTotal){let e=r.querySelector(nodeNames.hudQuantities).textContent;n*=e&&e.length>1?parseInt(e.substring(1),10):1}if(t){t.innerText=i(n);let e=document.createElement("img");e.src=chrome.runtime.getURL("images/Prices/coin.png"),t.appendChild(e),t.classList.add("voxels-blinking"),setTimeout(()=>{t.classList.remove("voxels-blinking")},500)}else{var o=document.createElement("div");o.classList.add("voxels-inventory-price"),o.innerText=i(n);let e=document.createElement("img");e.src=chrome.runtime.getURL("images/Prices/coin.png"),o.appendChild(e),r.appendChild(o),o.classList.add("voxels-blinking"),setTimeout(()=>{o.classList.remove("voxels-blinking")},500)}}})}async function sendRequestByHash(e){return new Promise(async(t,n)=>{chrome.storage.local.get("user_info",async function(r){let i={name:r.user_info,operation:"fetchPricesByHash",extra:e};try{let n=(await makeFetchRequest(apiURL,i)).data;userPremium&&"tasks"==currentActiveTab&&(getInventoryWithQuantities(n),setTaskQuantities());let r=e.map((e,t)=>({averageColor:e,price:n[t]}));t(r)}catch(e){n(e)}})})}function calculateAverageColor(e){let t=document.createElement("canvas"),n=t.getContext("2d");t.width=e.width,t.height=e.height,n.drawImage(e,0,0,e.width,e.height);let r=n.getImageData(0,0,e.width,e.height).data,i=0,o=0,a=0;for(let e=0;e<r.length;e+=4)i+=r[e],o+=r[e+1],a+=r[e+2];let l=r.length/4;return generateColorHash(i/l,o/l,a/l)}function generateColorHash(e,t,n){let r=`${Math.round(e)},${Math.round(t)},${Math.round(n)}`,i=0;for(let e=0;e<r.length;e++)i=(i<<5)-i+r.charCodeAt(e);return(i>>>0).toString(16)}