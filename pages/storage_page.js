function loadStorages(e){e?chrome.storage.local.get("user_info",async function(e){let t=e.user_info;try{let e=await makeFetchRequest(apiURL,{name:t,operation:"getStorage"});handleErrors(e)||("logout"==e?initiate():loadStoragePage(e.data))}catch(e){console.error(e)}}):chrome.storage.local.get("storage_data",function(e){e.storage_data?loadStoragePage(e.storage_data):loadStoragePage([])})}function loadStoragePage(e){let t=document.querySelector(".voxels-main");var a=document.createElement("div");a.classList.add("voxels-main-page"),a.classList.add("active"),t.appendChild(a),setStorages(e),reloadFooter()}function setStorages(e){for(let t in e)createStorage(e[t],t)}function createStorage(e,t){var a,o,r=document.querySelector(".voxels-storage-"+t);if(r)(o=(a=r).querySelector(".voxels-storages-container")).innerHTML="";else{(a=document.createElement("div")).classList.add("voxels-main-storage"),a.classList.add("voxels-storage-"+t);var n=document.createElement("div");n.classList.add("voxels-main-storage-header"),a.appendChild(n);var s=document.createElement("div");s.classList.add("voxels-main-storage-text"),s.textContent=t,n.appendChild(s);var i=document.createElement("div");i.classList.add("voxels-main-storage-buttons"),n.appendChild(i);var l=document.createElement("img");l.classList.add("voxels-storage-update"),l.src=chrome.runtime.getURL("/images/icons/icon__refresh.svg"),l.addEventListener("click",function(){isAddingStorage||intervalActive?showAlert("Cannot add storage while processing.","error"):(isAddingStorage=!0,updateStorage(0,t))}),i.appendChild(l);var d=document.createElement("div");d.classList.add("voxels-main-remove");var c=document.createElement("div");c.classList.add("voxels-remove-icon"),c.textContent="X",d.addEventListener("click",function(){removeStorage(t)}),d.appendChild(c),i.appendChild(d);var o=document.createElement("div");o.classList.add("voxels-storages-container")}if(e.forEach(e=>{if("0"===e){var t=document.createElement("div");t.classList.add("voxels-storageItem"),o.appendChild(t)}else{var a=e.display_name,r=e.image,n=e.quantity,t=document.createElement("div");t.classList.add("voxels-storageItem");var s=document.createElement("img");s.src=r,t.appendChild(s);var i=document.createElement("div");i.classList.add("voxels-storage-quantity"),i.textContent=n,t.appendChild(i),t.addEventListener("mouseenter",function(){var e=document.createElement("div");e.classList.add("voxels-hover-box"),e.textContent=a,document.body.appendChild(e);var o=t.getBoundingClientRect();e.style.position="absolute",e.style.top=o.top-e.offsetHeight+"px",e.style.left=o.left-50+"px"}),t.addEventListener("mouseleave",function(){document.querySelectorAll(".voxels-hover-box").forEach(function(e){e.parentNode&&e.parentNode.removeChild(e)})}),o.appendChild(t)}}),a.appendChild(o),!r){var m=document.querySelector(".voxels-main-page");m&&m.appendChild(a)}reloadFooter()}function updateStorage(e,t){0===e&&(e=getCurrentStorage()),!1!==e?chrome.storage.local.get("user_info",async function(a){let o={name:a.user_info,operation:"updateStorage",extra:{storageName:t,items:e.items}};try{let a=await makeFetchRequest(apiURL,o);a=a.data,"correct"===a.status?correctStorage(e,a,t,updateStorage):"success"===a.status?(createStorage(a.display_names_images,t),chrome.storage.local.get("storage_data",function(e){let o=e.storage_data||{};o[t]=a.display_names_images,chrome.storage.local.set({storage_data:o})})):handleStorageError(a),isAddingStorage=!1}catch(e){console.error(e)}}):(isAddingStorage=!1,showAlert("Please open a valid storage.","error"))}function removeStorage(e){confirmRemoval(e,function(t){t&&chrome.storage.local.get("user_info",async function(t){let a=t.user_info;try{let t=await makeFetchRequest(apiURL,{name:a,operation:"removeStorage",extra:e});if("success"===t.data){let t=`.voxels-storage-${e}`;document.querySelector(t).remove(),chrome.storage.local.get("storage_data",function(t){let a=t.storage_data||{};delete a[e],chrome.storage.local.set({storage_data:a})}),reloadFooter()}}catch(e){console.error(e)}})})}function confirmRemoval(e,t){var a=document.createElement("div");a.classList.add("voxels-popup-storage","voxels-popup-info"),a.innerHTML='<h3>Are you sure you want to remove storage:"'+e+'"?</h3><button id="confirmButton">Yes</button>';var o=document.createElement("div");function r(){a.remove()}o.className="voxels-popup-close",o.innerHTML="X",a.appendChild(o),document.body.appendChild(a),o.addEventListener("click",r),document.getElementById("confirmButton").addEventListener("click",function(){t(!0),r()})}function reloadFooter(){let e=document.querySelector(".voxels-main-page");document.querySelectorAll(".voxels-main-new").forEach(e=>{e.remove()}),document.querySelectorAll(".voxels-main-premium").forEach(e=>{e.remove()});let t=e.querySelectorAll(".voxels-main-storage").length;t<20&&(t>0?premium&&addStorageButton():addStorageButton()),premium||displayPremium()}let isAddingStorage=!1,intervalActive=!1;function addStorageButton(){let e=document.querySelector(".voxels-main");var t=document.createElement("div");t.classList.add("voxels-main-new","pixel-border"),e.appendChild(t),t.innerHTML="Add current storage",t.addEventListener("click",function(){isAddingStorage||intervalActive?showAlert("Cannot add storage while processing.","error"):(isAddingStorage=!0,addStorage(0,""))})}function getStorageName(e){var t=document.createElement("div");t.className="voxels-popup-storage",t.innerHTML='<h3>Enter Storage Name:</h3><input type="text" id="storageNameInput" placeholder="Enter storage name..."><button id="submitButton">OK</button>',t.classList.add("voxels-popup-info");var a=document.createElement("div");a.className="voxels-popup-close",a.innerHTML="X",t.appendChild(a),document.body.appendChild(t),a.addEventListener("click",function(){t.remove(),isAddingStorage=!1}),document.getElementById("storageNameInput").focus(),document.getElementById("submitButton").addEventListener("click",function(){var a=document.getElementById("storageNameInput").value.trim();/^[a-zA-Z0-9]+$/.test(a)?a.length<=10?(e(a),t.remove()):(isAddingStorage=!1,showAlert("Please enter a storage name with a maximum of 10 characters.","error")):(isAddingStorage=!1,showAlert("Please enter a storage name containing only letters or numbers.","error"))})}function addStorage(e,t){if(0===e&&(e=getCurrentStorage()),!1!==e){if(""===t){getStorageName(function(t){addStorage(e,t)});return}sendStorageRequest(e.items,t).then(a=>{"correct"===a.status?correctStorage(e,a,t,addStorage):"success"===a.status?(createStorage(a.display_names_images,t),chrome.storage.local.get("storage_data",function(e){let o=e.storage_data||{};Array.isArray(o)&&(o=convertArrayToObject(o)),o[t]=a.display_names_images,chrome.storage.local.set({storage_data:o})})):handleStorageError(a),isAddingStorage=!1}).catch(e=>{console.error(e),isAddingStorage=!1})}else isAddingStorage=!1,showAlert("Please open a valid storage.","error")}function correctStorage(e,t,a,o){intervalActive=!0;let r=0,n=t.item_names,s=[];for(let t=0;t<n.length;t++){if("multiple"===n[t]){let t=e.elements[r];if(t.classList.add("voxels-multiple"),t){let e=t.querySelector(nodeNames.storageItemBackground);e&&(e.style.filter="brightness(110%) hue-rotate(130deg)",s.push({imgElement:e,index:r}))}}r++}if(0===s.length){intervalActive=!1;return}showAlert("Couldn't identify all items. Hover over the red items.","info");let i=setInterval(function(){if(!document.querySelector(nodeNames.storageBox)){clearInterval(i),intervalActive=!1,showAlert("Stopped adding storage.","info");return}for(let t=0;t<s.length;t++){let{imgElement:a,index:o}=s[t],r=checkForToolTip(a),n=a.closest(nodeNames.storageItem).querySelector(nodeNames.storageQuantity),i=n?n.textContent.trim():"0";!1!==r&&(e.items[o]={type:"name",data:r,position:o,quantity:i},s.splice(t,1),t--)}0===s.length&&(clearInterval(i),intervalActive=!1,o(e,a))},100)}function checkForToolTip(e){let t=e.closest(nodeNames.storageItem);if(t){let a=t.getAttribute("aria-labelledby");if(a){let t=document.getElementById(a);if(t){let a=t.querySelector(".pixelFont").innerHTML.split("<br>")[0];return e.style.filter="",a}}}return!1}function sendStorageRequest(e,t){return new Promise(async(a,o)=>{chrome.storage.local.get("user_info",async function(r){let n={name:r.user_info,operation:"addStorage",extra:{storageName:t,items:e}};try{let e=await makeFetchRequest(apiURL,n);a(e.data)}catch(e){o(e)}})})}function getCurrentStorage(){let e=document.querySelectorAll(nodeNames.storageBox),t=[];return e.length>0&&(t.elements=e,storageItems=[],e.forEach((e,t)=>{let a=e.querySelector(nodeNames.storageImage),o=e.querySelector(nodeNames.storageQuantity);if(a&&o){if(a.complete){let e=calculateAverageColor(a);storageItems.push({type:"hash",data:e,position:t,quantity:o.textContent})}}else storageItems.push({position:t})}),t.items=storageItems,t)}function handleStorageError(e){e&&e.status&&e.status.error&&("4002"===e.status.error?showAlert("A storage with this name already exists.","error"):showAlert("An error occurred. Please try again.","error"))}